<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Управление правовыми фрагментами</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
</head>
<body>
  <section class="section">
    <div class="container">
      <h1 class="title is-3 has-text-centered">Управление правовыми фрагментами</h1>

      <div class="field is-grouped mb-3">
        <div class="control is-expanded">
          <input class="input" type="text" id="apiHost" placeholder="Хост и порт, например: http://localhost:8000" value="http://localhost:8000" />
        </div>
      </div>

      <div class="field is-grouped mb-5">
        <div class="control is-expanded">
          <input class="input" type="text" id="searchInput" placeholder="Поиск по содержанию..." />
        </div>
        <div class="control">
          <button class="button is-info" onclick="searchFragments()">Поиск</button>
        </div>
      </div>

      <div class="card mb-5">
        <header class="card-header">
          <p class="card-header-title">Добавить или обновить фрагмент</p>
        </header>
        <div class="card-content">
            <div class="field is-grouped">
                <div class="control is-expanded">
                    <input class="input" type="text" id="fragId" placeholder="frag_001"/>
                </div>
                <div class="control">
                    <button class="button is-small is-info" onclick="generateGuid()">GUID</button>
                </div>
            </div>
          <div class="field">
            <label class="label">ID документа</label>
            <div class="control">
              <input class="input" type="text" id="docId" placeholder="law_123" />
            </div>
          </div>
          <div class="field">
            <label class="label">Содержание</label>
            <div class="control">
              <textarea class="textarea" id="content" rows="3" placeholder="Текст правового фрагмента..."></textarea>
            </div>
          </div>
          <div class="field is-grouped">
            <div class="control">
              <button class="button is-primary" onclick="saveFragment()">Сохранить</button>
            </div>
            <div class="control">
              <button class="button is-light" onclick="clearForm()">Очистить</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <p class="card-header-title">Список фрагментов</p>
        </header>
        <div class="card-content">
          <div class="table-container">
            <table class="table is-fullwidth is-striped is-hoverable" id="fragmentsTable">
              <thead>
                <tr>
                  <th>ID фрагмента</th>
                  <th>ID документа</th>
                  <th>Содержание</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    function getApiUrl() {
      const host = document.getElementById("apiHost").value.trim();
      return host.endsWith("/") ? host + "laws" : host + "/laws";
    }

    async function request(url, method = "GET", data = null) {
      const options = {
        method,
        headers: { "Content-Type": "application/json" },
      };
      if (data) options.body = JSON.stringify(data);

      const response = await fetch(url, options);
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(errorText || 'Ошибка сети');
      }
      return response.status !== 204 ? await response.json() : null;
    }

    async function listFragments() {
      try {
        const fragments = await request(getApiUrl());
        renderTable(fragments);
      } catch (err) {
        alert("Ошибка загрузки фрагментов: " + err.message);
      }
    }

    async function searchFragments() {
      const query = document.getElementById("searchInput").value.trim();
      if (!query) return alert("Введите текст для поиска");

      try {
        const fragments = await request(`${getApiUrl()}/search?query=${encodeURIComponent(query)}`);
        renderTable(fragments);
      } catch (err) {
        alert("Ошибка поиска: " + err.message);
      }
    }

    function renderTable(fragments) {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";

      if (!fragments || fragments.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="has-text-centered">Фрагменты не найдены</td></tr>`;
        return;
      }

      fragments.forEach(frag => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${frag.fragment_id}</td>
          <td>${frag.document_id}</td>
          <td>${frag.content.substring(0, 100)}${frag.content.length > 100 ? "..." : ""}</td>
          <td>
            <button class="button is-small is-warning mr-2" onclick='editFragment(${JSON.stringify(frag)})'>Редактировать</button>
            <button class="button is-small is-danger" onclick='deleteFragment("${frag.fragment_id}")'>Удалить</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    function editFragment(frag) {
      document.getElementById("fragId").value = frag.fragment_id;
      document.getElementById("docId").value = frag.document_id;
      document.getElementById("content").value = frag.content;
    }

    async function saveFragment() {
      const fragId = document.getElementById("fragId").value.trim();
      const docId = document.getElementById("docId").value.trim();
      const content = document.getElementById("content").value.trim();

      if (!fragId || !docId || !content) {
        alert("Заполните все поля!");
        return;
      }

      const fragment = { fragment_id: fragId, document_id: docId, content };

      try {
        await request(getApiUrl(), "POST", fragment);
        alert("Фрагмент сохранён!");
        clearForm();
        listFragments();
      } catch (err) {
        alert("Ошибка сохранения: " + err.message);
      }
    }

    function generateGuid() {
        const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            const r = Math.random() * 16 | 0;
            const v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
        document.getElementById("fragId").value = uuid;
    }

    async function deleteFragment(id) {
      if (!confirm(`Удалить фрагмент ${id}?`)) return;

      try {
        await request(`${getApiUrl()}/${id}`, "DELETE");
        alert("Фрагмент удалён");
        listFragments();
      } catch (err) {
        alert("Ошибка удаления: " + err.message);
      }
    }

    function clearForm() {
      document.getElementById("fragId").value = "";
      document.getElementById("docId").value = "";
      document.getElementById("content").value = "";
    }

    window.onload = () => {
        listFragments();
    };
  </script>
</body>
</html>
